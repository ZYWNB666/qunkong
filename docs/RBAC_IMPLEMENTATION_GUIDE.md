# RBACæƒé™ç®¡ç†é‡æ„å®æ–½æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›RBACæƒé™ç®¡ç†é‡æ„çš„å®Œæ•´å®æ–½æŒ‡å—,åŒ…æ‹¬å·²å®Œæˆçš„å·¥ä½œå’Œåç»­æ­¥éª¤ã€‚

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. éœ€æ±‚åˆ†æä¸è®¾è®¡ âœ“

#### å®Œæˆçš„æ–‡æ¡£:
- **`docs/RBAC_REFACTORING_PLAN.md`** - è¯¦ç»†çš„é‡æ„è®¡åˆ’
  - RBACæ•°æ®æ¨¡å‹è®¾è®¡
  - è§’è‰²å’Œæƒé™å®šä¹‰
  - æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
  - APIæƒé™è¦æ±‚
  - å®æ–½æ—¶é—´è¡¨

#### è®¾è®¡è¦ç‚¹:
- âœ… ç®€åŒ–æƒé™æ¨¡å‹:åªä¿ç•™ç”¨æˆ·ç®¡ç†å’Œé¡¹ç›®ç®¡ç†
- âœ… adminè¶…çº§ç”¨æˆ·:ç‹¬ç«‹äºé¡¹ç›®,æ‹¥æœ‰å…¨å±€æƒé™
- âœ… é¡¹ç›®è‡ªæ²»:æ¯ä¸ªé¡¹ç›®å¯æœ‰å¤šä¸ªç®¡ç†å‘˜
- âœ… ç»†ç²’åº¦æƒé™:æ”¯æŒåŠŸèƒ½çº§åˆ«çš„æƒé™æ§åˆ¶
- âœ… èµ„æºéš”ç¦»:æ‰€æœ‰èµ„æºæŒ‰é¡¹ç›®å’Œç”¨æˆ·éš”ç¦»

### 2. æ•°æ®åº“è¿ç§»å‡†å¤‡ âœ“

#### å®Œæˆçš„è„šæœ¬:
- **`scripts/migrate_rbac_refactoring.sql`** - SQLè¿ç§»è„šæœ¬
- **`scripts/migrate_rbac.py`** - Pythonè¿ç§»è„šæœ¬
- **`scripts/README_RBAC_MIGRATION.md`** - è¿ç§»æŒ‡å—

#### è¿ç§»å†…å®¹:
1. âœ… åˆ›å»º`project_member_permissions`è¡¨ - å­˜å‚¨åŠŸèƒ½æƒé™
2. âœ… ä¸º`agents`è¡¨æ·»åŠ `project_id`å­—æ®µ
3. âœ… ä¸º`agent_system_info`è¡¨æ·»åŠ `project_id`å­—æ®µ
4. âœ… åˆ›å»ºé»˜è®¤é¡¹ç›®å¹¶è¿ç§»ç°æœ‰æ•°æ®
5. âœ… ä¸ºadminç”¨æˆ·æ·»åŠ é»˜è®¤é¡¹ç›®ç®¡ç†å‘˜æƒé™

## ğŸ“ å¾…å®æ–½å·¥ä½œ

### Phase 1: æ•°æ®åº“è¿ç§» (ä¼˜å…ˆçº§:é«˜)

**æ‰§è¡Œæ­¥éª¤:**
```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p qunkong > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. æ‰§è¡Œè¿ç§»
python scripts/migrate_rbac.py

# 3. éªŒè¯è¿ç§»ç»“æœ
mysql -u root -p qunkong -e "SELECT * FROM project_member_permissions LIMIT 1;"
```

**é¢„è®¡æ—¶é—´:** 1å°æ—¶

### Phase 2: æ›´æ–°æ•°æ®åº“æ¨¡å‹æ–‡ä»¶ (ä¼˜å…ˆçº§:é«˜)

éœ€è¦æ›´æ–°ä»¥ä¸‹æ–‡ä»¶:

#### 1. `app/models/project.py`
æ·»åŠ åŠŸèƒ½æƒé™ç®¡ç†æ–¹æ³•:

```python
class ProjectManager:
    def grant_permission(self, project_id: int, user_id: int, 
                        permission_key: str, granted_by: int) -> bool:
        """æˆäºˆç”¨æˆ·åŠŸèƒ½æƒé™"""
        
    def revoke_permission(self, project_id: int, user_id: int, 
                         permission_key: str) -> bool:
        """æ’¤é”€ç”¨æˆ·åŠŸèƒ½æƒé™"""
        
    def check_permission(self, project_id: int, user_id: int, 
                        permission_key: str) -> bool:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªåŠŸèƒ½æƒé™"""
        
    def get_user_permissions(self, project_id: int, user_id: int) -> List[str]:
        """è·å–ç”¨æˆ·åœ¨é¡¹ç›®ä¸­çš„æ‰€æœ‰æƒé™"""
        
    def set_user_permissions(self, project_id: int, user_id: int, 
                            permissions: List[str], granted_by: int) -> bool:
        """æ‰¹é‡è®¾ç½®ç”¨æˆ·æƒé™"""
```

**é¢„è®¡æ—¶é—´:** 2-3å°æ—¶

### Phase 3: å®ç°åç«¯æƒé™æ§åˆ¶é€»è¾‘ (ä¼˜å…ˆçº§:é«˜)

#### 1. æ›´æ–°`app/routers/rbac.py`

ç®€åŒ–æƒé™æ£€æŸ¥é€»è¾‘:

```python
# ç§»é™¤ç§Ÿæˆ·ç›¸å…³æ£€æŸ¥
# æ–°å¢åŠŸèƒ½æƒé™æ£€æŸ¥è£…é¥°å™¨

async def require_permission(permission_key: str):
    """è¦æ±‚ç”¨æˆ·æ‹¥æœ‰æŒ‡å®šçš„åŠŸèƒ½æƒé™"""
    def decorator(func):
        async def wrapper(*args, **kwargs):
            # 1. è·å–å½“å‰ç”¨æˆ·å’Œé¡¹ç›®
            # 2. æ£€æŸ¥adminæƒé™
            # 3. æ£€æŸ¥é¡¹ç›®æˆå‘˜èº«ä»½
            # 4. æ£€æŸ¥åŠŸèƒ½æƒé™
            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

**é¢„è®¡æ—¶é—´:** 3-4å°æ—¶

#### 2. æ›´æ–°APIè·¯ç”±

éœ€è¦æ›´æ–°çš„æ–‡ä»¶:
- `app/routers/agents.py` - Agentç®¡ç†API
- `app/routers/simple_jobs.py` - ä½œä¸šç®¡ç†API
- `app/routers/jobs.py` - å¤æ‚ä½œä¸šAPI
- `app/routers/projects.py` - é¡¹ç›®ç®¡ç†API
- `app/routers/users.py` - ç”¨æˆ·ç®¡ç†API

**å…³é”®æ”¹åŠ¨:**
```python
# ç¤ºä¾‹: Agentç®¡ç†API
@router.get("/agents")
async def get_agents(
    project_id: int = Query(...),
    current_user: Dict = Depends(require_permission('agent.view'))
):
    # ç§»é™¤tenant_idå‚æ•°
    # æ·»åŠ project_idå¿…éœ€å‚æ•°
    # ä½¿ç”¨æ–°çš„æƒé™æ£€æŸ¥
```

**é¢„è®¡æ—¶é—´:** 4-6å°æ—¶

### Phase 4: å‰ç«¯ä»£ç é‡æ„ (ä¼˜å…ˆçº§:ä¸­)

#### 1. ç§»é™¤ç§Ÿæˆ·ç®¡ç† (1-2å°æ—¶)

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶:
- `web/src/App.jsx` - ç§»é™¤ç§Ÿæˆ·è·¯ç”±
- `web/src/pages/TenantManagement.jsx` - åˆ é™¤æ–‡ä»¶
- å¯¼èˆªèœå• - ç§»é™¤ç§Ÿæˆ·ç®¡ç†èœå•é¡¹

#### 2. æ·»åŠ æƒé™é…ç½®ç•Œé¢ (3-4å°æ—¶)

åˆ›å»ºæ–°ç»„ä»¶:
- `web/src/components/PermissionConfig.jsx` - æƒé™é…ç½®ç»„ä»¶
- `web/src/pages/ProjectMemberPermissions.jsx` - æˆå‘˜æƒé™ç®¡ç†é¡µé¢

#### 3. å®ç°åŠŸèƒ½æƒé™æ§åˆ¶ (2-3å°æ—¶)

```jsx
// æƒé™æ§åˆ¶Hook
function usePermission(permissionKey) {
    const { currentUser, currentProject } = useAuth();
    
    // adminç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰æƒé™
    if (currentUser.role === 'admin') return true;
    
    // æ£€æŸ¥é¡¹ç›®æˆå‘˜æƒé™
    return checkProjectPermission(currentProject, currentUser, permissionKey);
}

// ä½¿ç”¨ç¤ºä¾‹
function BatchAddAgentButton() {
    const canBatchAdd = usePermission('agent.batch_add');
    
    if (!canBatchAdd) return null;
    
    return <Button>æ‰¹é‡æ·»åŠ ä¸»æœº</Button>;
}
```

**é¢„è®¡æ—¶é—´:** 6-9å°æ—¶

### Phase 5: æµ‹è¯•éªŒè¯ (ä¼˜å…ˆçº§:é«˜)

#### 1. åŠŸèƒ½æµ‹è¯• (2-3å°æ—¶)
- [ ] ç”¨æˆ·ç™»å½•å’Œè®¤è¯
- [ ] é¡¹ç›®åˆ›å»ºå’Œç®¡ç†
- [ ] é¡¹ç›®æˆå‘˜ç®¡ç†
- [ ] æƒé™é…ç½®å’Œç”Ÿæ•ˆ
- [ ] Agentç®¡ç†æƒé™
- [ ] ä½œä¸šç®¡ç†æƒé™
- [ ] æ‰§è¡Œå†å²æŸ¥çœ‹æƒé™

#### 2. æƒé™æµ‹è¯• (2-3å°æ—¶)
- [ ] adminç”¨æˆ·å…¨å±€æƒé™
- [ ] é¡¹ç›®adminæƒé™
- [ ] readwriteç”¨æˆ·æƒé™
- [ ] readonlyç”¨æˆ·æƒé™
- [ ] åŠŸèƒ½æƒé™æ§åˆ¶

#### 3. è¾¹ç•Œæµ‹è¯• (1-2å°æ—¶)
- [ ] æœªæˆæƒè®¿é—®æ‹’ç»
- [ ] è·¨é¡¹ç›®è®¿é—®æ‹’ç»
- [ ] æƒé™å˜æ›´å³æ—¶ç”Ÿæ•ˆ
- [ ] å¼‚å¸¸æƒ…å†µå¤„ç†

**é¢„è®¡æ—¶é—´:** 5-8å°æ—¶

## ğŸ“Š æ€»ä½“æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | å·¥ä½œå†…å®¹ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| Phase 1 | æ•°æ®åº“è¿ç§» | 1å°æ—¶ | é«˜ |
| Phase 2 | æ›´æ–°æ•°æ®åº“æ¨¡å‹ | 2-3å°æ—¶ | é«˜ |
| Phase 3 | åç«¯æƒé™æ§åˆ¶ | 7-10å°æ—¶ | é«˜ |
| Phase 4 | å‰ç«¯é‡æ„ | 6-9å°æ—¶ | ä¸­ |
| Phase 5 | æµ‹è¯•éªŒè¯ | 5-8å°æ—¶ | é«˜ |
| **æ€»è®¡** | **å…¨éƒ¨å·¥ä½œ** | **21-31å°æ—¶** | - |

æŒ‰å·¥ä½œæ—¥è®¡ç®—:çº¦3-4å¤©å®Œæˆ

## ğŸš€ å®æ–½å»ºè®®

### æ¨èå®æ–½é¡ºåº:

1. **ç¬¬1å¤©ä¸Šåˆ** - æ‰§è¡Œæ•°æ®åº“è¿ç§» (Phase 1)
2. **ç¬¬1å¤©ä¸‹åˆ** - æ›´æ–°æ•°æ®åº“æ¨¡å‹ (Phase 2)
3. **ç¬¬2å¤©å…¨å¤©** - å®ç°åç«¯æƒé™æ§åˆ¶ (Phase 3)
4. **ç¬¬3å¤©å…¨å¤©** - å‰ç«¯ä»£ç é‡æ„ (Phase 4)
5. **ç¬¬4å¤©å…¨å¤©** - æµ‹è¯•éªŒè¯å’Œä¿®å¤ (Phase 5)

### é£é™©æ§åˆ¶:

1. **å¤‡ä»½ç­–ç•¥**
   - è¿ç§»å‰å®Œæ•´å¤‡ä»½æ•°æ®åº“
   - ä»£ç ä½¿ç”¨Gitç‰ˆæœ¬æ§åˆ¶
   - ä¿ç•™å›æ»šæ–¹æ¡ˆ

2. **åˆ†é˜¶æ®µä¸Šçº¿**
   - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
   - å°èŒƒå›´ç”¨æˆ·è¯•ç”¨
   - å…¨é¢æ¨å¹¿ä¸Šçº¿

3. **ç›‘æ§å’Œæ—¥å¿—**
   - è®°å½•æ‰€æœ‰æƒé™æ£€æŸ¥
   - ç›‘æ§APIé”™è¯¯ç‡
   - æ”¶é›†ç”¨æˆ·åé¦ˆ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [RBACé‡æ„è®¡åˆ’](./RBAC_REFACTORING_PLAN.md) - è¯¦ç»†è®¾è®¡æ–‡æ¡£
- [æ•°æ®åº“è¿ç§»æŒ‡å—](../scripts/README_RBAC_MIGRATION.md) - è¿ç§»æ­¥éª¤è¯´æ˜

## â“ å¸¸è§é—®é¢˜

### Q: è¿ç§»ä¼šå½±å“ç°æœ‰ç”¨æˆ·å—?
**A:** ä¸ä¼šã€‚ç°æœ‰ç”¨æˆ·ä¼šè‡ªåŠ¨æˆä¸ºé»˜è®¤é¡¹ç›®çš„æˆå‘˜,ä¿æŒåŸæœ‰è®¿é—®æƒé™ã€‚

### Q: adminç”¨æˆ·éœ€è¦ç‰¹æ®Šå¤„ç†å—?
**A:** adminç”¨æˆ·ä¼šè‡ªåŠ¨è·å¾—æ‰€æœ‰é¡¹ç›®çš„ç®¡ç†å‘˜æƒé™,æ— éœ€é¢å¤–é…ç½®ã€‚

### Q: å¯ä»¥å›æ»šå—?
**A:** å¯ä»¥ã€‚æˆ‘ä»¬æä¾›äº†å®Œæ•´çš„æ•°æ®åº“å¤‡ä»½å’Œå›æ»šæ–¹æ¡ˆã€‚

### Q: æ€§èƒ½ä¼šå—å½±å“å—?
**A:** æ–°çš„æƒé™ç³»ç»Ÿæ›´åŠ ç®€åŒ–,ç†è®ºä¸Šæ€§èƒ½ä¼šæœ‰æ‰€æå‡ã€‚æˆ‘ä»¬ä¼šåœ¨æµ‹è¯•é˜¶æ®µç›‘æ§æ€§èƒ½æŒ‡æ ‡ã€‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜,è¯·æŸ¥çœ‹:
1. è¯¦ç»†è®¾è®¡æ–‡æ¡£
2. è¿ç§»æŒ‡å—
3. ä»£ç æ³¨é‡Š

æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0  
**æœ€åæ›´æ–°:** 2025-11-29  
**çŠ¶æ€:** è®¾è®¡å’Œå‡†å¤‡é˜¶æ®µå®Œæˆ,ç­‰å¾…å®æ–½